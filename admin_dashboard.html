<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --primary: #1e40af;
    --primary-light: #3b82f6;
     --secondary: #3b82f6;;
     --accent: #f59e0b;
    --light: #f8fafc;
    --gray: #718096;
    --light-gray: #e2e8f0;
    --white: #ffffff;
    --danger: #e53e3e;
    --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --radius: 8px;
    --transition: all 0.3s ease-in-out;
}
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
body { display:flex; min-height:100vh; background:var(--light); }

/* Sidebar */
.sidebar { width:260px; background: var(--secondary); color: var(--light); display:flex; flex-direction:column; padding:1.5rem; transition: width 0.3s; }
.sidebar.collapsed { width:80px; }
.sidebar h2 { font-size:1.5rem; margin-bottom:2.5rem; text-align:center; font-weight:700; transition: opacity 0.3s; letter-spacing: 1px; }
.sidebar.collapsed h2 { opacity:0; }
.menu-item { display:flex; align-items:center; padding:1rem; color: var(--light); text-decoration:none; border-radius: var(--radius); margin-bottom:0.5rem; cursor:pointer; transition: var(--transition); }
.menu-item:hover, .menu-item.active { background: var(--primary); }
.menu-item i { margin-right:1rem; font-style:normal; font-size: 1.2rem; }
.sidebar .submenu { display:none; flex-direction: column; margin-left:2rem; padding-left: 1rem; border-left: 1px solid var(--primary-light);}
.menu-item.open + .submenu { display:flex; }
.logout-btn { margin-top:auto; background: var(--danger); border:none; padding:1rem; border-radius:var(--radius); color: var(--white); font-weight:600; cursor:pointer; transition: var(--transition); text-align: center;}
.logout-btn:hover { background: #c53030; }

/* Main */
.main { flex:1; display:flex; flex-direction:column; }
.header { display:flex; justify-content: space-between; align-items:center; padding:1rem 2rem; background: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.1); position:sticky; top:0; z-index:1001; }
.header h1 { font-size:1.5rem; color: var(--secondary); }
.header .user-info { display:flex; align-items:center; gap:1rem; }
.header .toggle-btn { display:none; cursor:pointer; font-size:1.5rem; color: var(--secondary); }
.content { flex:1; padding:2rem; overflow-x:auto; }

/* Cards */
.cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:2rem; margin-bottom:2rem; }
.card { background: var(--white); padding:2rem; border-radius: var(--radius); box-shadow: var(--shadow); transition: var(--transition); border-left: 5px solid var(--primary-light);}
.card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
.card h3 { font-size:1.1rem; margin-bottom:0.75rem; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }
.card p { font-size:2rem; color: var(--primary); font-weight: 600; }

/* Table */
table { width:100%; border-collapse:collapse; background: var(--white); border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow); }
th, td { padding:1rem 1.5rem; border-bottom:1px solid var(--light-gray); text-align:left; word-wrap:break-word; }
th { background: var(--secondary); color: var(--white); text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;}
tr:hover { background-color: #f1f5f9; }

/* Filters */
.filter-section { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem; align-items: center;}
.filter-section select, .filter-section button { padding:0.75rem 1.25rem; border-radius: var(--radius); border:1px solid var(--light-gray); background:var(--white); cursor:pointer; transition:var(--transition); font-size: 0.9rem;}
.filter-section button { background: var(--primary-light); color:var(--white); border:none; }
.filter-section button:hover { background: var(--primary); }

/* Responsive */
@media(max-width:1024px){
    .cards { grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); }
}
@media(max-width:768px){
    .sidebar { position:fixed; left:-260px; top:0; height:100%; z-index:1000; box-shadow: 0 0 15px rgba(0,0,0,0.2);}
    .sidebar.active { left:0; }
    .header .toggle-btn { display:block; }
    .content { padding: 1.5rem; }
    .header { padding: 1rem; }
    th, td { padding: 0.75rem 1rem; }
}
@media(max-width:480px){
    body { flex-direction: column; }
    .main { width: 100%; }
    .header { flex-direction: column; align-items: flex-start; gap: 1rem;}
    .cards { grid-template-columns: 1fr; }
    .filter-section { flex-direction: column; align-items: stretch; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
}

/* Modal styles */
#editModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1001;
    display: none;
    justify-content: center;
    align-items: center;
}

#editModal > div {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    position: relative;
    z-index: 1002;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

/* Action buttons */
table button {
    padding: 0.25rem 0.5rem;
    margin: 0.125rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.3s;
}

table button:nth-child(1) {
    background-color: var(--primary-light);
    color: white;
}

table button:nth-child(1):hover {
    background-color: var(--primary);
}

table button:nth-child(2) {
    background-color: var(--danger);
    color: white;
}

table button:nth-child(2):hover {
    background-color: #c53030;
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <h2>Admin</h2>
    <div class="menu-item active"><i>üè†</i> Dashboard</div>
    <div class="menu-item" id="usersMenu"><i>üìã</i> Users Responses</div>
    <div class="submenu">
        <div class="menu-item">All Responses</div>
        <div class="menu-item">By Date</div>
    </div>
    <div class="menu-item"><i>‚öôÔ∏è</i> Settings</div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<!-- Main -->
<div class="main">
    <div class="header">
        <span class="toggle-btn" id="toggleBtn">‚ò∞</span>
        <h1>Dashboard</h1>
        <div class="user-info">
            <span>Admin</span>
            <img src="https://via.placeholder.com/40" alt="avatar" style="border-radius:50%;">
        </div>
    </div>

    <div class="content">
        <!-- Cards -->
        <div class="cards">
            <div class="card"><h3>Total Users</h3><p id="totalUsers">0</p></div>
            <div class="card"><h3>Responses Today</h3><p id="responsesToday">0</p></div>
            <div class="card"><h3>Most Selected Topic</h3><p id="topTopic">-</p></div>
        </div>

        <!-- Charts -->
        <div class="cards">
            <div class="card">
                <h3>Users by Age Group</h3>
                <canvas id="ageChart" height="200"></canvas>
            </div>
            <div class="card">
                <h3>Topics Distribution</h3>
                <canvas id="topicChart" height="200"></canvas>
            </div>
            <div class="card">
                <h3>Gender Distribution</h3>
                <canvas id="genderChart" height="200"></canvas>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <select id="filterGender">
                <option value="">All Genders</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
            <select id="filterAge">
                <option value="">All Ages</option>
                <option value="18-24">18-24</option>
                <option value="25-34">25-34</option>
                <option value="35-44">35-44</option>
                <option value="45+">45+</option>
            </select>
            <button onclick="applyFilter()">Apply Filter</button>
            <button onclick="exportPDF()">Export PDF</button>
        </div>

        <!-- Table -->
        <table id="responsesTable">
            <thead>
                <tr>
                    <th>Email</th><th>Gender</th><th>Age</th><th>Education</th><th>Workplace</th>
                    <th>Department</th><th>Job Position</th><th>Field</th><th>Topics</th><th>Other Topics</th><th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal">
    <div>
        <h2>Edit Response</h2>
        <form id="editForm">
            <input type="hidden" id="editResponseId">
            <div style="margin-bottom:1rem;">
                <label for="editEmail">Email</label>
                <input type="email" id="editEmail" style="width:100%; padding:0.5rem;">
            </div>
            <div style="margin-bottom:1rem;">
                <label for="editGender">Gender</label>
                <input type="text" id="editGender" style="width:100%; padding:0.5rem;">
            </div>
            <div style="margin-bottom:1rem;">
                <label for="editAge">Age</label>
                <input type="text" id="editAge" style="width:100%; padding:0.5rem;">
            </div>
            <div style="margin-bottom:1rem;">
                <label for="editTopics">Topics</label>
                <input type="text" id="editTopics" style="width:100%; padding:0.5rem;">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:1rem;">
                <button type="button" onclick="closeModal()" style="padding:0.5rem 1rem;">Cancel</button>
                <button type="submit" style="padding:0.5rem 1rem; background:var(--primary-light); color:white; border:none;">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
// Sidebar toggle
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleBtn');
toggleBtn.addEventListener('click', () => sidebar.classList.toggle('active'));
document.getElementById('usersMenu').addEventListener('click', () => {
    document.querySelector('.submenu').classList.toggle('open');
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
    await fetch('logout.php', { method:'POST', credentials:'include' });
    window.location.href = 'admin_login.html';
});

let allResponses = [];
let ageChart, topicChart, genderChart;

// Fetch responses from server
async function fetchResponses() {
    try {
        const res = await fetch('fetch_responses.php', { credentials: 'include' });
        const data = await res.json();
        allResponses = data;
        populateTable(allResponses);
    } catch (err) {
        console.error('Error fetching responses:', err);
    }
}

// Populate table
function populateTable(data) {
    const tbody = document.querySelector('#responsesTable tbody');
    tbody.innerHTML = '';
    const topicCount = {};
    const ageGroups = { "18-24":0, "25-34":0, "35-44":0, "45+":0 };
    const genderCounts = { "Male":0, "Female":0, "Other":0 };

    data.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${user.email}</td>
            <td>${user.gender}</td>
            <td>${user.age}</td>
            <td>${user.education}</td>
            <td>${user.workplace_name}</td>
            <td>${user.department}</td>
            <td>${user.job_position}</td>
            <td>${user.field_of_study}</td>
            <td>${user.topics}</td>
            <td>${user.other_topics}</td>
            <td>
                <button onclick="editResponse(${user.id})">Edit</button>
                <button onclick="deleteResponse(${user.id})">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);

        // Count topics
        user.topics.split(',').forEach(t => { if(t) topicCount[t] = (topicCount[t]||0)+1; });
        // Count age groups
        if(ageGroups[user.age] !== undefined) ageGroups[user.age]++;
        // Count genders
        if(genderCounts[user.gender] !== undefined) genderCounts[user.gender]++;
        else genderCounts["Other"]++;
    });

    document.getElementById('totalUsers').textContent = data.length;
    document.getElementById('responsesToday').textContent = data.filter(u => new Date(u.submitted_at).toDateString() === new Date().toDateString()).length;
    let top = Object.entries(topicCount).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('topTopic').textContent = top ? top[0] : '-';

    updateCharts(ageGroups, topicCount, genderCounts);
}

// Update Charts
function updateCharts(ageGroups, topicCount, genderCounts){
    if(ageChart) ageChart.destroy();
    if(topicChart) topicChart.destroy();
    if(genderChart) genderChart.destroy();

    // Age chart
    const ctxAge = document.getElementById('ageChart').getContext('2d');
    ageChart = new Chart(ctxAge, {
        type: 'bar',
        data: {
            labels: Object.keys(ageGroups),
            datasets: [{ label: 'Users', data: Object.values(ageGroups), backgroundColor:'#3b82f6' }]
        },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });

    // Topic chart
    const ctxTopic = document.getElementById('topicChart').getContext('2d');
    topicChart = new Chart(ctxTopic, {
        type: 'pie',
        data: {
            labels: Object.keys(topicCount),
            datasets: [{ data: Object.values(topicCount), backgroundColor:['#3b82f6','#f59e0b','#1e40af','#ef4444','#10b981','#8b5cf6','#f43f5e'] }]
        },
        options: { responsive:true }
    });

    // Gender chart
    const ctxGender = document.getElementById('genderChart').getContext('2d');
    genderChart = new Chart(ctxGender, {
        type: 'pie',
        data: {
            labels: Object.keys(genderCounts),
            datasets: [{
                data: Object.values(genderCounts),
                backgroundColor: ['#3b82f6','#f59e0b','#10b981']
            }]
        },
        options: { responsive:true }
    });
}

// Filter
function applyFilter() {
    const gender = document.getElementById('filterGender').value;
    const age = document.getElementById('filterAge').value;
    let filtered = allResponses;
    if(gender) filtered = filtered.filter(r=>r.gender===gender);
    if(age) filtered = filtered.filter(r=>r.age===age);
    populateTable(filtered);
}

// Export PDF
function exportPDF() {
    const gender = document.getElementById('filterGender').value;
    const age = document.getElementById('filterAge').value;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'export_pdf.php';
    form.target = '_blank';

    if(gender) { const g = document.createElement('input'); g.type='hidden'; g.name='gender'; g.value=gender; form.appendChild(g); }
    if(age) { const a = document.createElement('input'); a.type='hidden'; a.name='age'; a.value=age; form.appendChild(a); }

    document.body.appendChild(form);
    form.submit();
    form.remove();
}

// Initial fetch
fetchResponses();

function deleteResponse(id) {
    if (confirm('Are you sure you want to delete this response?')) {
        const formData = new FormData();
        formData.append('id', id);

        fetch('delete_response.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fetchResponses();
            } else {
                alert('Error deleting response: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function editResponse(id) {
    console.log('Edit button clicked for ID:', id);
    console.log('Available responses:', allResponses);
    console.log('Type of ID:', typeof id);
    console.log('Type of response IDs:', allResponses.map(r => ({id: r.id, type: typeof r.id})));
    
    // Convert id to number if it's a string
    const numericId = typeof id === 'string' ? parseInt(id) : id;
    const response = allResponses.find(r => r.id === numericId);
    
    console.log('Looking for response with ID:', numericId);
    console.log('Found response:', response);
    
    if (response) {
        document.getElementById('editResponseId').value = response.id;
        document.getElementById('editEmail').value = response.email;
        document.getElementById('editGender').value = response.gender;
        document.getElementById('editAge').value = response.age;
        document.getElementById('editTopics').value = response.topics;
        console.log('Setting modal display to flex');
        document.getElementById('editModal').style.display = 'flex';
        console.log('Modal should now be visible');
    } else {
        console.log('No response found with ID:', numericId);
        alert('Error: Response not found with ID: ' + numericId);
    }
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
}

document.getElementById('editForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);

    fetch('update_response.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            fetchResponses();
        } else {
            alert('Failed to update response: ' + data.error);
        }
    })
    .catch(error => console.error('Error:', error));
});
</script>
<!-- Footer -->
<footer id="site-footer" style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #0f172a;
  color: #f1f5f9;
  text-align: center;
  padding: 12px 10px;
  font-family: 'Poppins', sans-serif;
  font-size: 14px;
  border-top: 2px solid #3b82f6;
  z-index: 1000;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
  transition: transform 0.3s ease-in-out;
">
  <p style="margin: 0;">
    Powered by 
    <strong style="color: #3b82f6;">EthCocoders</strong> | 
    Visit us at 
    <a href="https://ethcocoders.gt.tc" 
       target="_blank" 
       style="color: #38bdf8; text-decoration: none;">
      ethcocoders.gt.tc
    </a>
  </p>
</footer>

<!-- Hide-on-scroll script -->
<script>
  let lastScrollY = window.scrollY;
  const footer = document.getElementById("site-footer");

  window.addEventListener("scroll", () => {
    if (window.scrollY > lastScrollY) {
      // scrolling down
      footer.style.transform = "translateY(100%)";
    } else {
      // scrolling up
      footer.style.transform = "translateY(0)";
    }
    lastScrollY = window.scrollY;
  });
</script>

</body>
</html>
