<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ኑር የትምህርት ማዕከል | መግቢያ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/home.css">
    <style>
        :root {
            --login-bg: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }
        
        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
            background: var(--login-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .login-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: auto;
        }
        
        .login-info {
            flex: 1;
            padding: 40px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .login-info h1 {
            font-size: 42px;
            margin-bottom: 20px;
        }
        
        .login-info p {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .features-list {
            margin-top: 30px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .feature-icon {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 24px;
        }
        
        .login-form-container {
            flex: 1;
            background-color: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 500px;
        }
        
        .login-form-container h2 {
            color: var(--dark-color);
            font-size: 28px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .form-control {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }
        
        .forgot-password {
            text-align: right;
            margin-bottom: 20px;
        }
        
        .forgot-password a {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }
        
        .btn-primary {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 30px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0;
            color: #666;
        }
        
        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #eee;
        }
        
        .divider span {
            padding: 0 10px;
            font-size: 14px;
        }
        
        .social-login {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .social-btn i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .social-btn.google i {
            color: #ea4335;
        }
        
        .social-btn.facebook i {
            color: #3b5998;
        }
        
        .social-btn:hover {
            background-color: var(--light-color);
        }
        
        .signup-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .signup-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        @media (max-width: 992px) {
            .login-container {
                flex-direction: column;
                max-width: 600px;
                padding: 20px;
            }
            
            .login-info {
                padding: 30px 20px;
                text-align: center;
            }
            
            .feature-item {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-info">
            <h1>የትምህርት ማህበረሰብ</h1>
            <p>የትምህርት ማህበረሰብ ለትምህርታዊ ማህበረሰብ አባላት እንደ መምህራን፣ ተማሪዎች እና ሥራ አስኪያጆች ለሚሰጡት አገልግሎቶች ዲጂታላዊ መድረክ ነው።</p>
            
            <div class="features-list">
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div>
                        <h3>ቀላል መማሪያ መሳሪያዎች</h3>
                        <p>ፈተናዎችን፣ የቤት ሥራዎችን እና የኮርስ ይዘቶችን ይፍጠሩ እና ያስተዳድሩ</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h3>የተማሪዎች እድገት ይከታተሉ</h3>
                        <p>የተማሪዎችን እድገት ይመልከቱ እና የትምህርት ውጤቶችን በአንድ ቦታ ይመዝግቡ</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h3>የተሻሻለ ግንኙነት</h3>
                        <p>ከወላጆች፣ አስተማሪዎች እና ተማሪዎች ጋር በቀላሉ ይገናኙ</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="login-form-container">
            <div class="logo-container">
                <div class="logo">የትምህርት ማህበረሰብ</div>
            </div>
            
            <h2>ወደ አካውንትዎ ይግቡ</h2>
            
            <form id="login-form" class="login-form">
                <div id="error-message" class="error-message" style="display: none;"></div>
                
                <!-- Emergency Redirect Buttons -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <p><strong>Emergency Access:</strong></p>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 10px;">
                        <button type="button" data-role="teacher" data-grade="9" class="emergency-redirect btn btn-sm" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 9 Teacher
                        </button>
                        <button type="button" data-role="teacher" data-grade="10" class="emergency-redirect btn btn-sm" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 10 Teacher
                        </button>
                        <button type="button" data-role="teacher" data-grade="11" class="emergency-redirect btn btn-sm" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 11 Teacher
                        </button>
                        <button type="button" data-role="teacher" data-grade="12" class="emergency-redirect btn btn-sm" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 12 Teacher
                        </button>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        <button type="button" data-role="student" data-grade="9" class="emergency-redirect btn btn-sm" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 9 Student
                        </button>
                        <button type="button" data-role="student" data-grade="10" class="emergency-redirect btn btn-sm" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 10 Student
                        </button>
                        <button type="button" data-role="student" data-grade="11" class="emergency-redirect btn btn-sm" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 11 Student
                        </button>
                        <button type="button" data-role="student" data-grade="12" class="emergency-redirect btn btn-sm" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px;">
                            Grade 12 Student
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="username">የተጠቃሚ ስም ወይም ኢሜይል</label>
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" name="username" class="form-control" placeholder="የተጠቃሚ ስምዎን ወይም ኢሜይልዎን ያስገቡ">
                        <div class="invalid-feedback"></div>
                    </div>
                    <small class="form-text text-muted">የመለያ ስምዎን ወይም የምዝገባ ኢሜይልዎን ይጠቀሙ።</small>
                </div>
                
                <div class="form-group">
                    <label for="password">የይለፍ ቃል</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" class="form-control" placeholder="የይለፍ ቃልዎን ያስገቡ">
                        <i class="fas fa-eye toggle-password"></i>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                
                <div class="forgot-password">
                    <a href="forgot-password.html">የይለፍ ቃል ረሱ?</a>
                </div>
                
                <button type="submit" class="btn btn-primary">ይግቡ</button>
            </form>
            
            <div class="divider">
                <span>ወይም</span>
            </div>
            
            <div class="social-login">
                <button class="social-btn google">
                    <i class="fab fa-google"></i> በ Google ይግቡ
                </button>
                <button class="social-btn facebook">
                    <i class="fab fa-facebook-f"></i> በ Facebook ይግቡ
                </button>
            </div>
            
            <div class="signup-link">
                አካውንት የለዎትም? <a href="register.html">አካውንት ይፍጠሩ</a>
            </div>
        </div>
    </div>

    <!-- Registration form tabs for switching -->
    <div class="tabs" id="auth-tabs">
        <button id="login-tab" class="tab active">ይግቡ</button>
        <button id="register-tab" class="tab">ይመዝገቡ</button>
    </div>
    
    <div id="login-content" class="tab-content">
        <!-- Login form content -->
    </div>
    
    <div id="register-content" class="tab-content" style="display: none;">
        <form id="registration-form">
            <div class="form-group">
                <label for="reg-fullName">ሙሉ ስም</label>
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="reg-fullName" name="fullName" class="form-control" placeholder="ሙሉ ስምዎን ያስገቡ">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="reg-username">የተጠቃሚ ስም</label>
                <div class="input-group">
                    <i class="fas fa-id-card"></i>
                    <input type="text" id="reg-username" name="username" class="form-control" placeholder="የተጠቃሚ ስም ይምረጡ">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="reg-email">ኢሜይል</label>
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="reg-email" name="email" class="form-control" placeholder="ኢሜይል አድራሻዎን ያስገቡ">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="reg-password">የይለፍ ቃል</label>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="reg-password" name="password" class="form-control" placeholder="የይለፍ ቃል ይምረጡ">
                    <i class="fas fa-eye toggle-password"></i>
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="role">ሚና</label>
                <div class="input-group">
                    <i class="fas fa-user-tag"></i>
                    <select id="role" name="role" class="form-control">
                        <option value="student">ተማሪ</option>
                        <option value="teacher">መምህር</option>
                    </select>
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            
            <div class="form-group" id="grade-container">
                <label for="grade">ክፍል</label>
                <div class="input-group">
                    <i class="fas fa-graduation-cap"></i>
                    <select id="grade" name="grade" class="form-control">
                        <option value="">ክፍል ይምረጡ</option>
                        <option value="Grade 9">9ኛ ክፍል</option>
                        <option value="Grade 10">10ኛ ክፍል</option>
                        <option value="Grade 11">11ኛ ክፍል</option>
                        <option value="Grade 12">12ኛ ክፍል</option>
                    </select>
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">ይመዝገቡ</button>
        </form>
    </div>

    <script src="../js/form-validator.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/login.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add emergency redirect handler
            const emergencyRedirectButtons = document.querySelectorAll('.emergency-redirect');
            if (emergencyRedirectButtons.length > 0) {
                emergencyRedirectButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const role = this.getAttribute('data-role');
                        const grade = this.getAttribute('data-grade');
                        
                        // Hardcoded redirect to teacher dashboard
                        const baseUrl = window.location.origin;
                        let dashboardUrl = '';
                        switch(role) {
                            case 'teacher':
                                dashboardUrl = `${baseUrl}/teachers/grade${grade}t/dashboard.html`;
                                break;
                            case 'student':
                                dashboardUrl = `${baseUrl}/students/grade${grade}s/dashboard.html`;
                                break;
                            default:
                                dashboardUrl = `${baseUrl}/index.html`;
                        }
                        
                        // Create fake user data for localStorage
                        const fakeUser = {
                            id: "emergency123",
                            username: "emergencyuser",
                            role: role,
                            grade: grade,
                            fullName: "Emergency User"
                        };
                        
                        // Store fake token and user in localStorage
                        localStorage.setItem('token', 'emergency-token-123');
                        localStorage.setItem('user', JSON.stringify(fakeUser));
                        
                        // Show message
                        alert("Redirecting directly to dashboard...");
                        
                        // Redirect immediately
                        window.location.href = dashboardUrl;
                    });
                });
            }
            
            const loginForm = document.getElementById('login-form');
            
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    clearErrors();
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        if (!username) showError('እባክዎ የተጠቃሚ ስምዎን ያስገቡ።', document.getElementById('username'));
                        if (!password) showError('እባክዎ የይለፍ ቃልዎን ያስገቡ።', document.getElementById('password'));
                        return;
                    }
                    
                    // Show loading state
                    const submitButton = document.querySelector('button[type="submit"]');
                    const originalText = submitButton.textContent;
                    submitButton.textContent = 'እየገባ...';
                    submitButton.disabled = true;
                    
                    try {
                        // Reset error message color
                        const errorMsg = document.getElementById('error-message');
                        if (errorMsg) {
                            errorMsg.style.color = '';
                        }
                        
                        // Add a timeout to reset the button after 10 seconds in case of hung requests
                        const buttonResetTimeout = setTimeout(() => {
                            console.log("Request timeout - resetting button");
                            submitButton.textContent = originalText;
                            submitButton.disabled = false;
                            showError("Server request timed out. Please try again or use the 'Skip Login' button.", errorMsg);
                        }, 10000);
                        
                        // Try the emergency bypass login endpoint first
                        let response = await fetch('/debug/bypass-login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ username })
                        });
                        
                        // If bypass login fails, try direct login
                        if (!response.ok) {
                            console.log('Bypass login endpoint failed, trying direct login...');
                            response = await fetch('/debug/direct-login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ username, password })
                            });
                        }

                        // If direct login fails, try debug login endpoint
                        if (!response.ok) {
                            console.log('Direct login endpoint failed, trying debug login...');
                            response = await fetch('/debug/login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ 
                                    username, 
                                    password,
                                    role: 'teacher' 
                                })
                            });
                        }
                        
                        // If debug endpoint fails, try standard endpoint as fallback
                        if (!response.ok) {
                            console.log('Debug login endpoint failed, trying main endpoint...');
                            response = await fetch('/api/auth/login', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ username, password })
                            });
                        }
                        
                        const data = await response.json();
                        
                        // Reset button
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        
                        if (!response.ok) {
                            showError(data.error || 'ለመግባት አልተሳካም።', document.getElementById('error-message'));
                            return;
                        }
                        
                        // Store token and user info in localStorage
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        // Initialize grades
                        initializeUserGrades({ ...data.user, token: data.token });
                        
                        // Print debug info
                        console.log("User role:", data.user.role);
                        console.log("User grade:", data.user.grade);
                        
                        // Extract and normalize grade (remove 'Grade ' prefix if present)
                        let userGrade = data.user.grade || '9';
                        if (typeof userGrade === 'string' && userGrade.includes('Grade ')) {
                            userGrade = userGrade.replace('Grade ', '');
                        }
                        console.log("Normalized grade:", userGrade);
                        
                        // Get base URL for full URL construction
                        const baseUrl = window.location.origin;
                        
                        // Determine dashboard URL based on role and grade
                        let dashboardUrl = '';
                        switch(data.user.role) {
                            case 'admin':
                                dashboardUrl = `${baseUrl}/admin/dashboard.html`;
                                break;
                            case 'teacher':
                                dashboardUrl = `${baseUrl}/teachers/grade${userGrade}t/dashboard.html`;
                                break;
                            case 'student':
                                dashboardUrl = `${baseUrl}/students/grade${userGrade}s/dashboard.html`;
                                break;
                            default:
                                dashboardUrl = `${baseUrl}/index.html`;
                        }
                        
                        console.log(`Dashboard URL: ${dashboardUrl}`);
                        
                        // Create a manual redirect link
                        const manualLink = document.createElement('a');
                        manualLink.href = dashboardUrl;
                        manualLink.textContent = "Click here if not redirected automatically";
                        manualLink.style.display = "block";
                        manualLink.style.textAlign = "center";
                        manualLink.style.marginTop = "20px";
                        manualLink.style.color = "#FF6B35";
                        document.getElementById('login-form').appendChild(manualLink);
                        
                        // Show successful login message
                        showError("Login successful! Redirecting...", document.getElementById('error-message'));
                        document.getElementById('error-message').style.color = "green";
                        
                        // Try redirect directly
                        console.log("Trying direct redirect with window.location.href");
                        window.location.href = dashboardUrl;
                        
                        // Also try with replace as backup
                        setTimeout(() => {
                            console.log("Fallback: Trying redirect with window.location.replace");
                            window.location.replace(dashboardUrl);
                            
                            // Last attempt
                            setTimeout(() => {
                                console.log("Last attempt: Direct assignment to location");
                                window.location = dashboardUrl;
                            }, 1000);
                        }, 500);
                    } catch (error) {
                        console.error('Login error:', error);
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        showError('ከሰርቨር ጋር ለመገናኘት አልተቻለም። እባክዎ ዳግም ይሞክሩ።', document.getElementById('error-message'));
                    }
                });
            }
            
            // Toggle password visibility
            const togglePassword = document.querySelector('.toggle-password');
            const passwordField = document.getElementById('password');
            
            if (togglePassword && passwordField) {
                togglePassword.addEventListener('click', function() {
                    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordField.setAttribute('type', type);
                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                });
            }
            
            // Function to clear error messages
            function clearErrors() {
                const errorElements = document.querySelectorAll('.invalid-feedback');
                const errorMessage = document.getElementById('error-message');
                
                if (errorMessage) errorMessage.style.display = 'none';
                
                errorElements.forEach(element => {
                    element.textContent = '';
                    element.style.display = 'none';
                });
            }
            
            // Function to show error messages
            function showError(message, element) {
                if (element && element.classList.contains('invalid-feedback')) {
                    element.textContent = message;
                    element.style.display = 'block';
                } else if (element && element.nextElementSibling) {
                    const feedback = element.nextElementSibling;
                    if (feedback.classList.contains('invalid-feedback')) {
                        feedback.textContent = message;
                        feedback.style.display = 'block';
                    }
                } else if (element && element.id === 'error-message') {
                    element.textContent = message;
                    element.style.display = 'block';
                } else {
                    const errorMessage = document.getElementById('error-message');
                    if (errorMessage) {
                        errorMessage.textContent = message;
                        errorMessage.style.display = 'block';
                    }
                }
            }
            
            // Simple implementation of initializeUserGrades
            function initializeUserGrades(user) {
                console.log("Initializing grades for user:", user.username);
                // This is a placeholder function - no actual API call needed for login
                return true;
            }
        });
    </script>
</body>
</html>